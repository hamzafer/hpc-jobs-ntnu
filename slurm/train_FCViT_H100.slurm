#!/bin/bash
#SBATCH --partition=GPUQ                       # GPU queue
#SBATCH --gres=gpu:h100:4                      # 4Ã— H100 on this node
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=4                    # 1 rank per GPU
#SBATCH --cpus-per-task=8                      # 8 CPU threads per rank
#SBATCH --mem=200G
#SBATCH --time=14-00:00:00
#SBATCH --job-name=FCViT_H100_normal
#SBATCH --output=logs/out/fcvit_h100_%j.out
#SBATCH --error=logs/err/fcvit_h100_%j.err

# â”€â”€ modules & conda env â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
module purge
module load Anaconda3/2024.02-1
module load CUDA/12.4.0

source activate /cluster/home/muhamhz/fcvit_env

# â”€â”€ diagnostics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "=============================================="
echo "Starting FCViT job on $(hostname) at $(date)"
nvidia-smi
python - <<'PY'
import torch, os
print("CUDA visible:", os.environ.get("CUDA_VISIBLE_DEVICES"))
print("CUDA available:", torch.cuda.is_available())
print("GPUs:", torch.cuda.device_count())
PY
echo "=============================================="

# â”€â”€ move to repo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
cd /cluster/home/muhamhz/fcvit-mt-ntnu

# â”€â”€ launch training with ðŸ¤— Accelerate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Perâ€‘GPU batch = 32  â†’  32 Ã— 4 GPUs Ã— 2 gradâ€‘accum = 256 global
CUDA_VISIBLE_DEVICES=0,1,2,3 \
accelerate launch \
  --num_processes 4 \
  main_train.py \
    --backbone vit_base_patch16_224 \
    --size_puzzle 225 \
    --size_fragment 75 \
    --num_fragment 9 \
    --lr 3e-05 \
    --epochs 500 \
    --weight_decay 0.05 \
    --batch_size 64 \
    --num_workers 12 \
    --data_path /cluster/home/muhamhz/data/imagenet \
    --output_dir /cluster/home/muhamhz/fcvit-mt-ntnu/output_fcvit_new

echo "=============================================="
echo "FCViT Training completed at $(date)"
echo "=============================================="
